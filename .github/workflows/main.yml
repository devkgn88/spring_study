name: Deploy to EC2 using Docker
on: 
 push:
  branches:
   - master
  paths:
   - 'todo/**'
jobs:
 deploy:
  runs-on: ubuntu-latest

  steps:
   # 저장소 클론
   - name: Checkout Repository
     uses: actions/checkout@v3
   # Java 17 설정
   - name: Set up JDK 17
     uses: actions/setup-java@v3
     with:
      distribution: 'temurin'
      java-version: '17'
   # Secrets 복사
   - name: Copy application-secret.properties
     run: |
      cd todo
      echo -e "${{ secrets.APP_SECRET_PROPERTIES }}" > src/main/resources/application-secret.properties
   # Gradle build 실행
   - name: Build with Gradle
     run: |
      cd todo
      chmod +x ./gradlew
      ./gradlew clean build -x test
   # 빌드된 jar파일 확인   
   - name: Check Jar file
     run: |
      ls -lh todo/build/libs/
   # EC2 서버에 SSH로 접속하여 배포
   - name: Deploy to EC2
     uses: appleboy/ssh-action@master
     with:
      host: ${{ secrets.EC2_HOST }}
      username: ubuntu
      key: ${{ secrets.EC2_SSH_KEY }}
      script: |
       # EC2에서 기존 프로세스 종료 (실행 중이면)
       PID=$(pgrep -f "todo-0.0.1-SNAPSHOT.jar") || true
       if [ -n "$PID" ]; then
        echo "Stopping existing application (PID: $PID)..."
        kill -9 $PID
       fi
       # JAR 파일을 /home/ubuntu/app/todo 로 복사
       mkdir -p /home/ubuntu/app/todo
       cd /home/ubuntu/app/todo     
       # Git 최신 코드 가져오기
       git pull origin master
       # Secrets 파일 다시 추가 (EC2에서도 필요)
       echo -e "${{ secrets.APP_SECRET_PROPERTIES }}" > src/main/resources/application-secret.properties
       # 최신 JAR 파일 복사
       rm -f todo.jar
       cp ~/actions-runner/_work/todo/todo/build/libs/todo-0.0.1-SNAPSHOT.jar todo.jar
       # 애플리케이션 실행 (백그라운드 실행)
       nohup java -jar todo.jar > app.log 2>&1 &
       echo "✅ Deployment Completed!"
